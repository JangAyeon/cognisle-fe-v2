name: production CI/CD

on: [pull_request] # 어떠한 브랜치에서든 PR이 생성되면 본 workflow가 실행됨

env:
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
  PROJECT_ID: ${{ secrets.CLOUD_RUN_PROJECT_NAME }}
  REGION: us-east1

jobs:
  install:
    runs-on: ubuntu-latest # 실행환경 ubuntu 최신버전
    steps:
      - name: Checkout branch # 레포지토리 소스를 runner로 가져오기
        uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version:
            '18'
            # Github Repository Secrets 이용해 리액트 파일 내 환경 변수 파일 생성
      - name: Generate Environment Variables File for Production
        run: |
          echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .env.production
          echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_CLIENT_ID=$NEXT_PUBLIC_DISCORD_CLIENT_ID" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_CLIENT_SECRET=$NEXT_PUBLIC_DISCORD_CLIENT_SECRET" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_TOKEN=$NEXT_PUBLIC_DISCORD_TOKEN" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_REDIRECT_URI=$NEXT_PUBLIC_DISCORD_REDIRECT_URI" >> .env.production
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXT_PUBLIC_DISCORD_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_DISCORD_CLIENT_ID }}
          NEXT_PUBLIC_DISCORD_CLIENT_SECRET: ${{ secrets.NEXT_PUBLIC_DISCORD_CLIENT_SECRET }}
          NEXT_PUBLIC_DISCORD_TOKEN: ${{ secrets.NEXT_PUBLIC_DISCORD_TOKEN }}
          NEXT_PUBLIC_DISCORD_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_DISCORD_REDIRECT_URI }}

      - name: Cypress install
        uses: cypress-io/github-action@v6
        with:
          # Disable running of tests within install job
          runTests: false
          install-command: yarn install
          build: yarn run build

      - name: Save build folder
        uses: actions/upload-artifact@v4
        with:
          name: static-next-build
          ##if-no-files-found: error
          path: .next/
  cypress-run:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download the build folder
        uses: actions/download-artifact@v4
        with:
          name: static-next-build

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          install-command: yarn install
          start: yarn run dev
          browser: chrome
