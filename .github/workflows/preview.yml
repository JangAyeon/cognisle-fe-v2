name: production CI/CD

on: [pull_request] # 어떠한 브랜치에서든 PR이 생성되면 본 workflow가 실행됨

env:
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
  PROJECT_ID: ${{ secrets.CLOUD_RUN_PROJECT_NAME }}
  REGION: us-east1

jobs:
  continuous-integration:
    runs-on: ubuntu-latest # 실행환경 ubuntu 최신버전
    steps:
      - name: Checkout branch # 레포지토리 소스를 runner로 가져오기
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Generate Environment Variables File for Production
        run: |
          echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .env.production
          echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_CLIENT_ID=$NEXT_PUBLIC_DISCORD_CLIENT_ID" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_CLIENT_SECRET=$NEXT_PUBLIC_DISCORD_CLIENT_SECRET" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_TOKEN=$NEXT_PUBLIC_DISCORD_TOKEN" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_REDIRECT_URI=$NEXT_PUBLIC_DISCORD_REDIRECT_URI" >> .env.production
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXT_PUBLIC_DISCORD_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_DISCORD_CLIENT_ID }}
          NEXT_PUBLIC_DISCORD_CLIENT_SECRET: ${{ secrets.NEXT_PUBLIC_DISCORD_CLIENT_SECRET }}
          NEXT_PUBLIC_DISCORD_TOKEN: ${{ secrets.NEXT_PUBLIC_DISCORD_TOKEN }}
          NEXT_PUBLIC_DISCORD_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_DISCORD_REDIRECT_URI }}

      - name: Install dependencies
        run: yarn install
      - name: Check Lint
        run: yarn lint
      - name: Save build folder
        uses: actions/upload-artifact@v4
        with:
          name: build
          build: yarn run build
          path: .

  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout branch # 레포지토리 소스를 runner로 가져오기
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Download the build folder
        uses: actions/download-artifact@v4
        with:
          name: build
          path: .
      - name: Check Unit Test
        run: yarn test:jest
