name: production CI/CD

on:
  push:
    branches:
      - develop # main 브랜치에 "push"될 때만 본 workflow 실행

env:
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
  PROJECT_ID: ${{ secrets.CLOUD_RUN_PROJECT_NAME }}
  REGION: us-east1
  # project-name but it can be anything you want
  REPO_NAME: nextjs-cloud-run

jobs:
  preview-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

        # Github Repository Secrets 이용해 리액트 파일 내 환경 변수 파일 생성
      - name: Generate Environment Variables File for Production
        run: |
          echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .env.production
          echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_CLIENT_ID=$NEXT_PUBLIC_DISCORD_CLIENT_ID" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_CLIENT_SECRET=$NEXT_PUBLIC_DISCORD_CLIENT_SECRET" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_TOKEN=$NEXT_PUBLIC_DISCORD_TOKEN" >> .env.production
          echo "NEXT_PUBLIC_DISCORD_REDIRECT_URI=$NEXT_PUBLIC_DISCORD_REDIRECT_URI" >> .env.production
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXT_PUBLIC_DISCORD_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_DISCORD_CLIENT_ID }}
          NEXT_PUBLIC_DISCORD_CLIENT_SECRET: ${{ secrets.NEXT_PUBLIC_DISCORD_CLIENT_SECRET }}
          NEXT_PUBLIC_DISCORD_TOKEN: ${{ secrets.NEXT_PUBLIC_DISCORD_TOKEN }}
          NEXT_PUBLIC_DISCORD_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_DISCORD_REDIRECT_URI }}

      - name: test Echo
        run: |
          echo ${{secrets.NEXTAUTH_SECRET}} | sed 's/./& /g' 
          echo ${{secrets.NEXTAUTH_URL}} | sed 's/./& /g' 
          echo ${{secrets.NEXT_PUBLIC_DISCORD_CLIENT_ID}} | sed 's/./& /g' 
          echo ${{secrets.NEXT_PUBLIC_DISCORD_CLIENT_SECRET}} | sed 's/./& /g' 
          echo ${{secrets.NEXT_PUBLIC_DISCORD_TOKEN}} | sed 's/./& /g' 
          echo ${{secrets.NEXT_PUBLIC_DISCORD_REDIRECT_URI}} | sed 's/./& /g'
          echo ${{secrets.CLOUD_RUN_PROJECT_NAME}} | sed 's/./& /g'
